# Streams
카프카 스트림즈는 토픽에 적재된 데이터를 실시간으로 변환하여 다른 토픽에 적재하는 라이브러리이다.  
스트림즈 애플리케이션 또는 카프카 브로커의 장애가 발생하더라도 정확히 한번 (exactly once)할 수 있도록 장애 허용 시스템을 갖고 있어서 데이터 처리 안정성이 매우 뛰어나다.

## 스트림즈 내부 구조
스트림즈 애플리케이션은 내부적으로 스레드를 1개 이상 생성할 수 있으며, 스레드는 1개 이상의 태스크를 가진다.  
스트림즈의 **태스크(task)는 스트림즈 애플리케이션을 실행하면 생기는 데이터 처리 최소 단위이다.**  
- 예를 들어 3개의 파티션으로 이루어진 토픽을 처리하는 스트림즈 애플리케이션을 실행하면 내부에 3개의 태스크가 생성이 된다.

## 토폴로지(topology)
토폴로지란 2개 이상의 노드들과 선으로 이루어진 집합을 뜻한다.  
스트림즈에서 사용하는 토폴로지의 형태는 트리 형태와 유사하다. (토폴로지으 종류에는 링(ring)형, 트리(tree)형, 성(star)형 등이 있다.)

## 프로세서와 스트림
스트림즈에서는 토폴로지를 이루는 노드를 하나의 "프로세서(processor)"라고 부르고 노드와 노드를 이은 선을 "스트림(stream)"이라고 부른다.

### 소스 프로세서
- 소스 프로세서는 가장 데이터가 첫번째로 들어오는 프로세서 이다.
- 데이터를 처리하기 위하여 최초로 선언 해야 하는 노드로, 하나 이상의 토픽에서 데이터를 가져오는 역할을 한다.

### 스트림 프로세서
- 스트림 프로세서는 다른 프로세서가 반환한 데이터를 처리하는 역할을 한다.
- 변환, 분기처리와 같은 로직이 데이터 처리의 일종이라고 볼 수 있다.

### 싱크 프로세서
- 싱크 프로세서는 데이터를 특정 카프카 토픽으로 저장하는 역할을 하며 스트림즈로 처리된 데이터의 최종 도착지이다.

## KStream
KStream은 레코드의 흐름을 표현한 것으로 메시지 키와 메시지 값으로 구성되어 있다.  
컨슈머로 토픽을 구독하는 것과 동일한 개념으로 볼 수 있다. (토픽에 데이터가 적재되면 스트림을 통해 데이터가 표현된다.)

## KTable
KTable은 KStream과 다르게 메시지 키를 기준으로 가장 최신의 값만 사용한다.  
KStream은 토픽의 모든 레코드를 조회할 수 있지만 KTable은 유니크한 메시지 키를 기준으로 가장 최신의 레코드만 조회할 수 있다.
- 예를 들어 토픽에 순서대로 A(key):1(value), B(key):2(value), A(key):3(value) 순으로 레코드가 적재되면 KTable은 A(key):3(value), B(key):2(value) 레코드만 조회할 수 있다.

## 코파티셔닝(co-partitioning)
KStream과 KTable 데이터를 조인하려면 반드시 코파티셔닝되어 있어야 한다.  
**코파티셔닝이란 조인을 하는 2개의 데이터의 파티션 개수가 동일하고 파티셔닝 전략을 동일하게 맞추는 작업이다.**
- 파티션 개수가 갖고 파티셔닝 전략이 같은 경우에는 동일한 메시지 키를 가진 데이터가 동일한 태스크에 들어가는 것을 보장한다.
- 이를 통해서 각 태스크는 KStream의 레코드와 KTable의 메시지 키가 동일할 경우 조인을 수행할 수 있다.

## GlobalKTable
코파티셔닝이되지 않은 KStream과 KTable을 조인해서 사용하고 싶다면 KTable을 GlobalKTable으로 선언하여 사용하면 된다.  
GlobalKTable은 KTable과 다르게 GlobalKTable으로 정의된 데이터는 스트림즈 애플리케이션의 **모든 태스크에 동일하게 공유**되어 사용이 되기 때문이다.

### GlobalKTable을 사용해야 하는 경우
- GlobalKTable의 데이터가 클 경우 애플리케이션의 모든 태스크가 GlobalKTable의 데이터를 갖고 있기 때문에 애플리케이션이 큰 용량이 필요하고 부담이 가해진다.
- GlobalKTable의 데이터가 적을 경우에만 GlobalKTable을 활용해야 한다. (어쩔 수 없이 GlobalKTable을 사용하는 경우 retention 기간을 조정하여 사용)

즉, 큰 용량의 토픽은 GlobalKTable이 아닌 코파티셔닝이 된 KTable을 이용하여 KStream과 조인한다.

### 리파티셔닝
리파티셔닝은 특정 토픽에 있는 파티션을 조인하고자 하는 토픽의 파티션 개수와 맞춰주는 작업이다.  
-> 예를 들어 파티션 개수가 3개인 A토픽과 파티션 개수가 2개인 B토픽이 존재하는데 두 토픽을 KStream, KTable 으로 조인하려면 코파티셔닝이 되어야 한다. 그래서 B 토픽의 파티션을 3개로 늘리는 리파티셔닝 작업을 수행하여 코파티셔닝이 된 상태로 조인해야 한다.  
